<!DOCTYPE html>
<html>
  <head>
    <title>Devops-kurs</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="https://github.com/downloads/gnab/remark/remark-0.4.4.min.js" type="text/javascript"></script>

    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <style type="text/css" media="screen">
      /* Slideshow styles */
      .content {
        font-size: 40px;
        font-family: Open Sans, Arial, sans-serif;
        color: #333333;
        letter-spacing: -2px;
      }

      h1 {
        font-size: 1.2em;
      }

      #slideshow .slide .content pre, #slideshow .slide .content code {
        font-size: 32px;
        border: solid grey 3px;
        border-radius: 5px;
        background: #DDDDDD;
      }

      a:visited {
        color: blue;
      }


      .small {
        font-size: 35px;
      }

      .smaller {
        font-size: 30px;
      }

      #slideshow .slide .small-code code {
        font-size: 20px;
      }

      #slideshow .slide .content {
        padding: 0.5em 2em 0.5em 2em;
      }

      code {
        letter-spacing: 0px;
      }
    </style>

  </head>
  <body>
    <textarea id="source">

class: center, middle

# Puppet and Vagrant workshop

---

# Slides

http://bekkopen.github.com/devops-kurs/

---

# Vagrant

* ```vagrant up``` and you have a virtual machine ready
* Check in configuration of your virtual machine
* Configure in Vagrantfile

[vagrantup.com](http://vagrantup.com)

---

# Vagrant usages

* Production-like environment
* Test everything on your local machine
* Isolated environment

---

# Vagrant shared disk

* ```/vagrant``` on virtual machine
* Directory ```vagrant up``` is run from

---

# Excercise (5 min):

* Run ```vagrant up``` to boot up your virtual machine
* Run ```vagrant ssh``` to log into it
* Run ```ls /vagrant/```
* Run ```touch /vagrant/created_in_vm.txt```
* Find the file you created on you local disk

---
class: smaller, small-code

# Vagrant lifecycle

* ```vagrant up```
  * Boots and provisions image
* ```vagrant reload```
  * Reload changes to Vagrantfile and reboots
* ```vagrant provision```
  * Re-runs provisioning
* ```vagrant halt```
  * Stops the VM, changes are saved
* ```vagrant destroy```
  * Deletes the VM

---

# Shell provision

* Make vagrant run a script each time the VM is created
* ```vagrant provision``` to run the same script again
* Must be repeatable (will be run multiple times by Vagrant)

---
class: small-code

# Example

```Vagrantfile``` is Ruby code!

```ruby
Vagrant.configure("2") do |config|
  config.vm.provision "shell", path: "test.sh"
end
```

---

# Exercise (10 min):

* Create a provision script that Vagrant uses
* The script should create ```foo.txt``` with some content
* Run ```vagrant provision``` to test your setup

[Vagrant shell provisioning](http://docs.vagrantup.com/v2/provisioning/shell.html)

---

# Multiple VMs

* Different configuration
* Different provisioning
* Create network for all VMs

---
class: small-code

# Example

```ruby
Vagrant::Config.run do |config|
  # Shared config
  config.vm.box = "devops-kurs"

  config.vm.define :web do |web_config|
    web_config.vm.provision :shell, :path => "bin/web.sh"
  end

  config.vm.define :db do |db_config|
    db_config.vm.provision :shell, :path => "bin/db.sh"
  end
end
```

---

# Run commands on one VM

* ```vagrant ssh web```
* ```vagrant provision db```

---

# Run commands on all VMs

* ```vagrant provision```
  * Provision all VMs
* ```vagrant ssh```
  * Fails!

---

# Exercise (10 min):

* Modify your ```Vagrantfile``` to create two virtual machines
* Use two different provisioning scripts for the VMs

Docs:
[Multiple VMs](http://docs.vagrantup.com/v2/multi-machine/index.html)<br/>
[Config reference](http://docs.vagrantup.com/v2/vagrantfile/index.html)

---

# Puppet

* Configuration management
* Infrastructure as code

---

# Puppet

* Platform independant(-ish)
* Supports Win, Linux, OS X
* Master - slave architecture
* Enforces consistent configuration across environments and servers

---

# Puppet mode

* Master - Slave
* Run once
  * ```puppet apply file.pp```

---

# Resources

* File
* User
* Package
* Service
* Host
* ...

---

# Example

```ruby
user { 'smat':
  ensure => present,
}
```
---

# Example

```ruby
file { '/vagrant/testfile':
  ensure => present,
  content => "Some file content",
  owner  => vagrant,
  group => vagrant,
}
```

---

# Excercise hints

* Create your puppet-file in ```manifests/```
* Run
  * ```vagrant ssh web```
  * ```cd /vagrant/manifests```
  * ```sudo puppet apply <filename>.pp```

---

# Exercise (10 min):

* Use ```vagrant ssh web``` to enter your VM
* ```cd /vagrant``` to access your local files
* Create a recipie that
  * Creates [a user](http://docs.puppetlabs.com/references/latest/type.html#user) ```devops``` with managed home directory
  * Creates [a file](http://docs.puppetlabs.com/references/latest/type.html#file) ```.bashrc``` in the user home directory
* Do next exercise

---

# Exercise (5 min):

* Configure Vagrant to run your puppet manifests
* Use ```manifests/default.pp``` as your root puppet recipie
* ```vagrant provision web``` should run your puppet recipie

Docs:
[Vagrant documentation](http://docs.vagrantup.com/v2/provisioning/puppet_apply.html)

---
class: small-code

# Classes (ssh.pp)

```ruby
class ssh {
  package {'openssh-server':
    ensure => present,
  }

  service {'sshd':
    ensure => running,
  }
}
```

---

# Classes

```ruby
include ssh
```

---
class: small-code

# Dependencies

```ruby
class ssh {
  package {'openssh-server':
    ensure => present,
  }

  file {'/etc/sshd_config':
    ensure => present,
    require => Package['openssh-server'],
  }

  service {'sshd':
    ensure => running,
    subscribe => File['/etc/sshd_config'],
  }
}
```

---
class: small-code

# Dependencies (reverse)

```ruby
class ssh {
  package {'openssh-server':
    ensure => present,
    before => File['/etc/sshd_config'],
  }

  file {'/etc/sshd_config':
    ensure => present,
    notify => Service['sshd'],
  }

  service {'sshd':
    ensure => running,
  }
}
```

---

# Stopping a service

```ruby
service {'iptables':
  ensure => stopped,
}
```

---

# Exercise (20 min):

* Create a class that installs Apache (httpd)
* Start Apache (httpd)
* Disable firewall (iptables)
* Forward port 80 from the VM to 8585 on the local machine
* Open http://localhost:8585/ and see a result

Docs:
[Package](http://docs.puppetlabs.com/references/latest/type.html#package)
[Service](http://docs.puppetlabs.com/references/latest/type.html#service)
[Vagrant docs](http://docs.vagrantup.com/v2/networking/forwarded_ports.html)

---
class: small-code

# Modules

```
manifests/
  \ default.pp
modules/
  \ web
    | manifests/
      \ init.pp
  \ ssh/
    ...
```
---

# Modules

* Auto-import root class
  - ```web```
  - ```modules/web/manifests/init.pp```
* Auto-import class in module
  - ```web::server```
  - ```modules/web/manifests/server.pp```

---

# Modules

```
modules/web/manifests/server.pp
```

```ruby
class web::server {
}
```

```ruby
include web::server
```

---

# Exercise (5 min):

* Refactor Apache into a module
* Check that nothing happens when you run ```vagrant provision```

Hint: Vagrant must know which directory your modules are in.

Docs [Vagrant doc](http://docs.vagrantup.com/v2/provisioning/puppet_apply.html)

---
class: small-code

# Inheritance

```ruby
class ssh {
  package {'openssh-client':
    ensure => present,
  }
}
class ssh-server inherits ssh {
  package {'openssh-server':
    ensure => present,
  }
}
```

---
class: small-code

# Node

```ruby
node default {
  include ssh::server
}
node app inherits default {
  include web::server
}
node "*.domain.com", "somehost.otherdomain.com" inherits app {
  include web::site
}
```

---

# Exercise (5 min):

* Set a hostname for each VM
* Apply the hostname with ```vagrant reload```
* Configure nodes in puppet
  * ```web``` should install Apache
  * ```db``` should not

Docs:
[Host name](http://docs.vagrantup.com/v2/vagrantfile/machine_settings.html)
[Node resource](http://docs.puppetlabs.com/puppet/latest/reference/lang_node_definitions.html)

---
class: center, middle

# BONUS!!!

---
class: small-code

# Define

```ruby
define java::deployer($public_key = nil, $ensure = present) {
  file {"/home/${name}/.ssh/authorized_keys":
    content => $public_key,
    ensure => $ensure,
  }
}
```

---

# Parameterization

```ruby
java::deployer {'smat':
  public_key => 'ssh-rsa AAAAB3Nc2...',
}
```

```ruby
java::deployer {'smat':
  ensure => absent,
}
```

---

# Define vs Class

* Define: Multiple instances
  * Web-site
  * Database-schema
* Class: Singleton
  * Web-server
  * Database-server

---

# Putting it all together

---
class: smaller, small-code

```ruby
define java::deployer($public_key, $ensure = present) {
  user {$name:
    ensure => $ensure,
    managehome => true,
    home => "/home/${name}",
  }
  $directory = $ensure ? {
    present => 'directory',
    default => $ensure
  }
  file {"/home/${name}/.ssh":
    ensure => $directory,
    mode => 0755,
  }
  file {"/home/${name}/.ssh/authorized_keys":
    ensure => $ensure,
    content => $public_key,
    mode => 0644,
  }
}
```

---

# Previous slide

* Defined resource
  * Implicit variable ```$name```
* Parameters
* Puppet language (case)
* Variables
* Difference between "" and ''

---
class: small-code

# Modules

```
manifests/
  \ default.pp
modules/
  \ web
    | manifests/
    | \ init.pp
    | files/
    \ templates/
  \ ssh/
    ...
```
---

# Fileserver

* Puppet has an internal fileserver
* Files in ```files/``` and ```templates/``` are available

---
class: small-code

# Fileserver

```ruby
class ssh::server {
  file { '/etc/sshd_config':
    ensure => present,
    source => "puppet:///modules/ssh/sshd_config"
  }
}
```

```bash
modules/ssh/files/sshd_config
```

---
class: small-code

# Templates

* ERB (Embedded Ruby) files
* Inherits variables from resource

---
class: small-code

# Templates

```ruby
class ssh::server($listen = '0.0.0.0') {
  file { '/etc/sshd_config':
    ensure => present,
    content => template("ssh/sshd_config.erb")
  }
}
```

```bash
modules/ssh/templates/sshd_config.erb
```

---
class: small-code

# Templates

```erb
ListenAddress <%= listen %>
```

---
class: smaller, small-code

# Exercise (30 min):

* Create a Puppet resource to create a site/virtual host in Apache
* An example config-file is found here: [sample-vhost.conf](https://github.com/bekkopen/devops-kurs/blob/master/example/sample-vhost.conf)
* Apache loads all files in ```/etc/httpd/conf.d```
* Each site should have its own user, that can add HTML-files
* Each site should use its own port
* Create a ```index.html``` for each site
* Use port forward in Vagrant to forward new site to your machine locally
* Test that everything works

---
class: smaller, small-code

# Bonus: Reverse proxy

It is possible to configure Apache to forward request to another webserver. This is often used in test environments to let multiple applications share the same port.

Example: You have two applications:

* App1 on http://localhost:8001/app1
* App2 on http://localhost:8002/app2.

Apache could then let all requests to /app1 be forwarded to port 8001 and all requests to /app2 be forwarded to port 8002

---

# Bonus exercise: Reverse proxy

* Create a Puppet resource to create a site with multiple reverse proxies
* Let ```/google``` on your Apache show google.com, and ```/bing``` show bing.com
* Use the example [sample-forward-proxy.conf](https://github.com/bekkopen/devops-kurs/blob/master/example/sample-forward-proxy.conf)

---

# Sveinung Dalatun

# Stian Mathiassen

# Stein Inge Morisbak


    </textarea>
    <div id="slideshow"></div>
  </body>
</html>
